# PR Changelog – Connect/Protobuf v2 Migration & Cleanup

Use the sections below for your PR description. Version recommendation is at the end.

---

## Summary

This PR migrates the SDK from Connect/Protobuf v1 to v2, removes obsolete generated Connect files, aligns auth `customAttributes` with v2 types, and updates Node.js requirements and README.

---

## 1. Connect / Protobuf v2 migration (existing work in this branch)

### Dependencies (`package.json`)
- **@bufbuild/protobuf**: `^2.7.0` (was v1.x)
- **@connectrpc/connect** and **@connectrpc/connect-node**: `^2.1.1` (was v1.x)
- **protoc-gen-es** (dev): `^2.0.0` (was v1.x)
- **Removed**: `protoc-gen-connect-es` (no longer used in v2)
- **Removed**: `undici` overrides (vulnerability addressed by Connect v2 stack)

### Codegen (`buf.gen.yaml`)
- Uses only the **protoc-gen-es** v2 plugin (single plugin, no Connect plugin).
- Generated `*_pb.ts` files now contain both message types and **service descriptors** (e.g. `RolesService`), so separate `*_connect.ts` files are no longer generated.

### Generated protobuf code (`src/pkg/grpc/`)
- All `*_pb.ts` files **regenerated** with protoc-gen-es v2:
  - Plain TypeScript types and schema-based APIs (e.g. `create(Schema, init)` instead of `new MessageType()`).
  - Message types are types/interfaces; request/response creation uses `create(Schema, init)`.

### Stub files for external proto dependencies
- Added **stub files** so the v2 registry can resolve external protos that are imported by Scalekit protos but not shipped in this repo:
  - `src/pkg/grpc/buf/validate/validate_pb.ts`
  - `src/pkg/grpc/google/api/annotations_pb.ts`
  - `src/pkg/grpc/google/api/field_behavior_pb.ts`
  - `src/pkg/grpc/google/api/visibility_pb.ts`
  - `src/pkg/grpc/protoc-gen-openapiv2/options/annotations_pb.ts`
- Each stub provides minimal `GenFile`-compatible descriptors (e.g. `get extension() { return []; }`) so runtime no longer throws on missing dependency descriptors.

### TypeScript / build
- **tsconfig.json**: `target` set to **ES2017**; `lib` and `typeRoots` updated for v2 typings.

### SDK source code
- **connect.ts**: Uses `createClient` and `Client` from `@connectrpc/connect` (v2 API).
- **Client files** (e.g. `role.ts`, `domain.ts`, `connection.ts`, `organization.ts`, `user.ts`, `directory.ts`, `session.ts`, `auth.ts`, `passwordless.ts`, `webauthn.ts`, `permission.ts`):
  - Use `Client<typeof XService>` and get the service from the corresponding `*_pb.ts` (e.g. `RolesService` from `roles_pb`).
  - Use `create(Schema, init)` for message creation instead of `new MessageType()`.
  - Use `Partial<T>` for request init where appropriate.
  - Handle **Timestamp** and **Struct** via v2 APIs (Struct fields are represented as `JsonObject` / plain objects).
- **Typos**: `grpcConncet` → `grpcConnect` where applicable.
- **errors/base-exception.ts**: Uses `ConnectError.findDetails(ErrorInfoSchema)` (v2 API).

### Tests
- **tests/utils/test-data.ts** (and any test files using proto messages): Use `create(Schema, init)` instead of `new MessageType()`; added type assertions where needed for `create()` (e.g. `init as Parameters<typeof create>[1]`).

---

## 2. Removal of obsolete `*_connect.ts` files

- **Deleted** 11 legacy files that were generated by **protoc-gen-connect-es** (v1) and are no longer produced or referenced:
  - `src/pkg/grpc/scalekit/v1/auditlogs/auditlogs_connect.ts`
  - `src/pkg/grpc/scalekit/v1/auth/auth_connect.ts`
  - `src/pkg/grpc/scalekit/v1/auth/passwordless_connect.ts`
  - `src/pkg/grpc/scalekit/v1/auth/webauthn_connect.ts`
  - `src/pkg/grpc/scalekit/v1/connections/connections_connect.ts`
  - `src/pkg/grpc/scalekit/v1/directories/directories_connect.ts`
  - `src/pkg/grpc/scalekit/v1/domains/domains_connect.ts`
  - `src/pkg/grpc/scalekit/v1/organizations/organizations_connect.ts`
  - `src/pkg/grpc/scalekit/v1/roles/roles_connect.ts`
  - `src/pkg/grpc/scalekit/v1/sessions/sessions_connect.ts`
  - `src/pkg/grpc/scalekit/v1/users/users_connect.ts`
- Service descriptors now live in the respective `*_pb.ts` files; SDK and tests import from `*_pb.ts` only.

---

## 3. Auth `customAttributes` (Struct → JsonObject)

- **src/auth.ts**:
  - **Behavior**: `customAttributes` is passed through directly to `create(UserSchema, user)` with **no** `Struct.fromJson()` (or similar). In v2, `google.protobuf.Struct` fields are represented as **JsonObject** (plain objects); `create()` accepts and passes them through as-is.
  - **Types**: `UserInput` now uses `JsonObject` from `@bufbuild/protobuf` for `customAttributes` (aligned with generated `User` in `auth_pb.ts`), with a short comment that the proto field is Struct → JsonObject in v2.

---

## 4. Node.js requirement and README

- **package.json**: `engines.node` set to **`>=18.14.1`**.
- **README.md**:
  - **Pre-requisites**: Note updated to state that the Node.js SDK requires **Node.js 18.14.1 or later** and references `engines` in package.json.
  - **Minimum Requirements**: Table and note updated:
    - Node.js version: **18.14.1+** (replacing 16.0.0+).
    - Note updated to require Node.js 18.14.1+ and recommend the current LTS release.

---

## Backward compatibility

- **Typical usage**: Unchanged for callers using the high-level client methods with plain JavaScript/TypeScript objects (e.g. `scalekitClient.role.createRole({ ... })`).
- **Breaking**: Consumers who relied on **deep imports** of gRPC message classes and used `new CreateRole(...)` (or similar) will break; in v2 those are types/schemas and creation is via `create(Schema, init)`. Such usage is not part of the public API.

---

## Version recommendation

- **Current version**: `2.1.9`
- **Suggested version for this release**: **`2.2.0`** (minor bump)

**Reasoning**:  
The migration is backward compatible for normal SDK usage. The only breaking changes are for edge cases (direct use of generated message constructors). A **minor** bump (2.2.0) is appropriate to signal new behavior and dependency upgrades without implying broad breaking changes.

If you prefer to signal a “major upgrade” (e.g. dependency and engine bumps) more prominently, you could use **`3.0.0`** instead; the codebase and compatibility are the same, only the version number and changelog messaging would differ.

---

## Checklist for PR

- [ ] All tests pass (`npm test`)
- [ ] Build succeeds (`npm run build`)
- [ ] Node.js 18.14.1+ verified
- [ ] CHANGELOG or release notes updated (if you maintain one)
- [ ] Version in `package.json` set to chosen release (e.g. `2.2.0`)
