syntax = "proto3";

package scalekit.v1.environments;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/any.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";
import "scalekit/v1/commons/commons.proto";
import "scalekit/v1/options/options.proto";

option go_package = "github.com/scalekit-inc/scalekit/pkg/grpc/environments";

service EnvironmentService {
  rpc CreateEnvironment(CreateEnvironmentRequest) returns (CreateEnvironmentResponse) {
    option (scalekit.v1.options.auth_option) = {
      // special permission for SK default env
      authentication_type: WORKSPACE_SESSION_CLIENT
    };
    option (google.api.http) = {
      post: "/api/v1/environments"
      body: "environment"
    };
  }

  rpc UpdateEnvironment(UpdateEnvironmentRequest) returns (UpdateEnvironmentResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION};

    option (google.api.http) = {
      patch: "/api/v1/environments/{id}"
      body: "environment"
    };
  }

  rpc UpdateEnvironmentDomain(UpdateEnvironmentDomainRequest) returns (UpdateEnvironmentResponse) {
    option (scalekit.v1.options.auth_option) = {
      // special permission for SK default env
      authentication_type: WORKSPACE
    };

    option (google.api.http) = {
      patch: "/api/v1/environments/{id}:update"
      body: "environment"
    };
  }

  rpc GetEnvironment(GetEnvironmentRequest) returns (GetEnvironmentResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION};
    option (google.api.http) = {get: "/api/v1/environments/{id}"};
  }

  rpc ListEnvironment(ListEnvironmentsRequest) returns (ListEnvironmentsResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION};
    option (google.api.http) = {get: "/api/v1/environments"};
  }

  rpc DeleteEnvironment(DeleteEnvironmentRequest) returns (google.protobuf.Empty) {
    option (scalekit.v1.options.auth_option) = {
      // special permission for SK default env
      authentication_type: BLOCKED
    };

    option (google.api.http) = {delete: "/api/v1/environments/{id}"};
  }

  rpc GetRequiredDNSRecords(GetDNSRecordsRequest) returns (GetDNSRecordsResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      post: "/api/v1/environments/{id}/dns"
      body: "*"
    };
  }

  rpc VerifyDNSRecords(GetDNSRecordsRequest) returns (google.protobuf.Empty) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      post: "/api/v1/environments/{id}/dns:verify"
      body: "*"
    };
  }

  rpc CreateCustomDomain(CreateCustomDomainRequest) returns (CreateCustomDomainResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      post: "/api/v1/environments/{id}/custom-domains"
      body: "*"
    };
  }

  rpc CheckCustomDomainStatus(GetEnvironmentRequest) returns (GetEnvironmentResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      post: "/api/v1/environments/{id}/custom-domains:check"
      body: "*"
    };
  }

  rpc GenerateNewSamlCertificate(GenerateSamlCertificateRequest) returns (GenerateSamlCertificateResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      post: "/api/v1/environments/{id}/saml-certificates:generate"
      body: "*"
    };
  }
  rpc UpdatePortalCustomization(UpdatePortalCustomizationRequest) returns (UpdatePortalCustomizationResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      put: "/api/v1/environments/{id}/portal_customizations"
      body: "customization_settings"
      additional_bindings: [
        {
          put: "/api/v1/environments/{id}/customizations"
          body: "customization_settings"
        }
      ]
    };
  }

  rpc GetPortalCustomization(GetPortalCustomizationRequest) returns (GetPortalCustomizationResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CUSTOMER_PORTAL};
    option (google.api.http) = {
      get: "/api/v1/environments/{id}/portal_customizations"
      additional_bindings: [
        {get: "/api/v1/environments/-/portal_customizations"}]
    };
  }

  rpc CreateAssetUploadURL(CreateAssetUploadUrlRequest) returns (CreateAssetUploadUrlResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION};
    option (google.api.http) = {
      post: "/api/v1/environments/{id}/asset"
      body: "asset_settings"
    };
  }

  rpc UpdateFeatures(UpdateFeaturesRequest) returns (GetFeaturesResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION};
    option (google.api.http) = {
      put: "/api/v1/environments/{id}/features"
      body: "features"
    };
  }

  rpc EnableFSAFeature(EnableFSAFeatureRequest) returns (google.protobuf.Empty) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      post: "/api/v1/environments/{id}/features/fsa/enable"
      body: "*"
    };
  }

  rpc EnableFeature(EnableFeatureRequest) returns (google.protobuf.Empty) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CUSTOMER_PORTAL};
    option (google.api.http) = {post: "/api/v1/environments/{id}/features/{feature_id}:enable"};
  }

  rpc DisableFeature(DisableFeatureRequest) returns (google.protobuf.Empty) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CUSTOMER_PORTAL};
    option (google.api.http) = {post: "/api/v1/environments/{id}/features/{feature_id}:disable"};
  }

  rpc GetFeatures(GetFeaturesRequest) returns (GetFeaturesResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CUSTOMER_PORTAL};
    option (google.api.http) = {get: "/api/v1/environments/{id}/features"};
  }

  rpc CreateEnvironmentSessionSettings(CreateEnvironmentSessionSettingsRequest) returns (CreateEnvironmentSessionSettingsResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      post: "/api/v1/environments/{id}/session-settings"
      body: "session_settings"
    };
  }

  rpc CreateEnvironmentUserManagement(CreateEnvironmentUserManagementRequest) returns (CreateEnvironmentUserManagementResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      post: "/api/v1/environments/{id}/settings/user-management"
      body: "user_management"
    };
  }

  rpc GetEnvironmentSessionSettings(GetEnvironmentSessionSettingsRequest) returns (GetEnvironmentSessionSettingsResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {get: "/api/v1/environments/{id}/session-settings"};
  }

  rpc GetEnvironmentUserManagement(GetEnvironmentUserManagementRequest) returns (GetEnvironmentUserManagementResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {get: "/api/v1/environments/{id}/settings/user-management"};
  }

  rpc UpdateEnvironmentSessionSettings(UpdateEnvironmentSessionSettingsRequest) returns (UpdateEnvironmentSessionSettingsResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      patch: "/api/v1/environments/{id}/session-settings"
      body: "session_settings"
    };
  }

  rpc UpdateEnvironmentUserManagement(UpdateEnvironmentUserManagementRequest) returns (UpdateEnvironmentUserManagementResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      patch: "/api/v1/environments/{id}/settings/user-management"
      body: "user_management"
    };
  }

  rpc GetContext(GetContextRequest) returns (GetContextResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION};
    option (google.api.http) = {get: "/api/v1/environments/{environment_id}/contexts"};
  }

  rpc UpdateContext(UpdateContextRequest) returns (google.protobuf.Empty) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION};
    option (google.api.http) = {
      put: "/api/v1/environments/{environment_id}/contexts"
      body: "context"
    };
  }

  rpc GetCurrentSession(GetCurrentSessionRequest) returns (GetCurrentSessionResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CUSTOMER_PORTAL};
    option (google.api.http) = {
      get: "/api/v1/environments/{id}/sessions:me"
      additional_bindings: [
        {get: "/api/v1/environments/-/sessions:me"},
        {get: "/api/v1/sessions:me"}]
    };
  }

  rpc GetScalekitResources(ScalekitResourceRequest) returns (ScalekitResourceResponse) {
    option (scalekit.v1.options.auth_option) = {authentication_type: WORKSPACE_SESSION_CLIENT};
    option (google.api.http) = {
      post: "/api/v1/fetch:bulk"
      body: "*"
    };
  }
}

message CreateCustomDomainRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  string custom_domain = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 250
    },
    (buf.validate.field).required = true
  ];
}

message CreateCustomDomainResponse {
  Environment environment = 1;
}

message GetDNSRecordsRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  string custom_domain = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 250
    },
    (buf.validate.field).required = true
  ];
}

message GetDNSRecordsResponse {
  repeated DNSRecords dns_records = 1;
}

message DNSRecords {
  string host_name = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 250
  }];
  string type = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 250
  }];
  string value = 3 [(buf.validate.field).string = {
    min_len: 1
    max_len: 250
  }];
}

message Environment {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  google.protobuf.Timestamp create_time = 2;
  google.protobuf.Timestamp update_time = 3;
  string display_name = 4 [(buf.validate.field).string = {
    min_len: 1
    max_len: 200
  }];
  string domain = 5 [(buf.validate.field).string = {
    min_len: 1
    max_len: 250
  }];
  scalekit.v1.commons.RegionCode region_code = 6;
  scalekit.v1.commons.EnvironmentType type = 7;
  optional string custom_domain = 8;
  CustomDomainStatus custom_domain_status = 9;
} // workspace_id is not included here, It should derived from the token or domain via ctx.

enum CustomDomainStatus {
  UNSPECIFIED = 0;
  PENDING = 1;
  ACTIVE = 2;
  FAILED = 3;
  INITIAL = 4;
}

message CreateEnvironment {
  string display_name = 4 [(buf.validate.field).string = {
    min_len: 1
    max_len: 200
  }];
  reserved 5; // domain is not updatable here.
  optional scalekit.v1.commons.RegionCode region_code = 6;
  optional scalekit.v1.commons.EnvironmentType type = 7;
} // workspace_id is not included here, It should derived from the token or domain via ctx.

message UpdateEnvironment {
  optional string display_name = 4 [(buf.validate.field).string = {
    min_len: 1
    max_len: 2000
  }];
  reserved 5; // domain is not updatable here.
  reserved 6; // region is not updatable here.
  reserved 7; // type is not updatable here.
}

message UpdateEnvironmentDomain {
  reserved 4; // display_name is not updatable here.
  optional string domain = 5 [(buf.validate.field).string = {
    min_len: 1
    max_len: 250
  }];
}

message CreateEnvironmentRequest {
  CreateEnvironment environment = 1 [(buf.validate.field).required = true];
}

message CreateEnvironmentResponse {
  Environment environment = 1;
}

message UpdateEnvironmentRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  UpdateEnvironment environment = 2 [(buf.validate.field).required = true];
}

message UpdateEnvironmentDomainRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  UpdateEnvironmentDomain environment = 2 [(buf.validate.field).required = true];
}

message UpdateEnvironmentResponse {
  Environment environment = 1;
}

message GetEnvironmentRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
}

message GetEnvironmentResponse {
  Environment environment = 1;
}

message ListEnvironmentsRequest {
  uint32 page_size = 1;
  string page_token = 2;
}

message ListEnvironmentsResponse {
  string next_page_token = 1;
  uint32 total_size = 2;
  repeated Environment environments = 3;
}

message DeleteEnvironmentRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
}

message GenerateSamlCertificateRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
}

message GenerateSamlCertificateResponse {
  string id = 1;
  string certificate = 2;
  int64 expiry = 3;
}

message UpdatePortalCustomizationResponse {
  string environmentId = 1;
  google.protobuf.Struct customization_settings = 2;
}

message UpdatePortalCustomizationRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  google.protobuf.Struct customization_settings = 2 [(buf.validate.field).required = true];
}

message GetPortalCustomizationRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 0
    max_len: 32
  }];
}

message GetPortalCustomizationResponse {
  string environmentId = 1;
  google.protobuf.Struct customization_settings = 2;
}

message CreateAssetUploadUrlResponse {
  string upload_url = 1;
  string fetch_url = 2;
}

message CreateAssetUploadUrlRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];

  AssetSettings asset_settings = 2;
}

message AssetSettings {
  AssetCategory category = 1 [(buf.validate.field).required = true];
  string extension = 2 [(buf.validate.field).string = {
    in: [
      "jpg",
      "jpeg",
      "png"
    ]
  }];
}

// can be extended to support more asset types
enum AssetCategory {
  ASSET_CATEGORY_UNSPECIFIED = 0;
  PORTAL_CUSTOMIZATION_IMAGE = 1;
}

message UpdateFeaturesRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  repeated EnvironmentFeature features = 2 [(buf.validate.field).required = true];
}

message EnableFSAFeatureRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
}

message GetFeaturesRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
}

message GetFeaturesResponse {
  repeated EnvironmentFeature features = 1;
}

message EnableFeatureRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  string feature_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
  }];
}

message DisableFeatureRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  string feature_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
  }];
}

message EnvironmentFeature {
  string name = 1;
  bool enabled = 2;
}

message GetEnvironmentSessionSettingsRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
}

message GetEnvironmentUserManagementRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
}

message GetEnvironmentSessionSettingsResponse {
  SessionSettings session_settings = 1;
}

message GetEnvironmentUserManagementResponse {
  UserManagement user_management = 1;
}

message CreateEnvironmentSessionSettingsRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  SessionSettings session_settings = 2 [(buf.validate.field).required = true];
}

message CreateEnvironmentUserManagementRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  UserManagement user_management = 2 [(buf.validate.field).required = true];
}

message CreateEnvironmentSessionSettingsResponse {
  string environment_id = 1;
  SessionSettings session_settings = 2;
}

message CreateEnvironmentUserManagementResponse {
  string environment_id = 1;
  UserManagement user_management = 2;
}

message UpdateEnvironmentSessionSettingsRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  SessionSettings session_settings = 2 [(buf.validate.field).required = true];
}

message UpdateEnvironmentUserManagementRequest {
  string id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 32
    prefix: "env"
  }];
  UserManagement user_management = 2 [(buf.validate.field).required = true];
}

message UpdateEnvironmentSessionSettingsResponse {
  string environment_id = 1;
  SessionSettings session_settings = 2;
}

message UpdateEnvironmentUserManagementResponse {
  string environment_id = 1;
  UserManagement user_management = 2;
}

message SessionSettings {
  google.protobuf.Int32Value access_token_expiry = 1 [(buf.validate.field).int32 = {
    gte: 1
    lte: 43200
  }];
  google.protobuf.Int32Value client_access_token_expiry = 2 [(buf.validate.field).int32 = {
    gte: 1
    lte: 43200
  }];
  google.protobuf.Int32Value absolute_session_timeout = 3 [(buf.validate.field).int32 = {
    gte: 1
    lte: 525600
  }];
  google.protobuf.BoolValue session_management_enabled = 4;
  google.protobuf.Int32Value idle_session_timeout = 5 [(buf.validate.field).int32 = {
    gte: 1
    lte: 10080
  }];
  google.protobuf.BoolValue idle_session_enabled = 6;
  CookiePersistenceType cookie_persistence_type = 7;
  CookieSameSiteSetting cookie_same_site_setting = 8;
  google.protobuf.StringValue cookie_custom_domain = 9;
}

message UserManagement {
  google.protobuf.BoolValue allow_duplicate_user_identities = 1;
  google.protobuf.BoolValue allow_multiple_memberships = 2;
  google.protobuf.BoolValue allow_organization_signup = 3;
  OrgUserRelationshipType org_user_relationship = 4 [(buf.validate.field).enum.defined_only = true];
  google.protobuf.BoolValue enable_max_users_limit = 5;
  google.protobuf.Int32Value max_users_limit = 6 [(buf.validate.field).int32 = {
    gte: 1
    lte: 99999
  }];
  google.protobuf.UInt32Value invitation_expiry = 7 [(buf.validate.field).uint32 = {
    gte: 1
    lte: 43200
  }];
  // Indicates whether disposable email domains are blocked for user signup/invite.
  google.protobuf.BoolValue block_disposable_email_domains = 9;

  // Indicates whether public email domains are blocked for user signup/invite.
  google.protobuf.BoolValue block_public_email_domains = 10;
}

enum OrgUserRelationshipType {
  OrgUserRelationshipType_UNSPECIFIED = 0;
  SINGLE_ORGANIZATION = 1;
  MULTIPLE_ORGANIZATIONS = 2;
}

enum CookiePersistenceType {
  CookiePersistenceType_UNSPECIFIED = 0;
  PERSISTENT = 1;
  SESSION = 2;
}

enum CookieSameSiteSetting {
  CookieSameSiteSetting_UNSPECIFIED = 0;
  LAX_MODE = 1;
  NONE_MODE = 2;
}

message GetContextRequest {
  string environment_id = 2;
}

message GetContextResponse {
  google.protobuf.Struct context = 1;
}

message UpdateContextRequest {
  string environment_id = 2;
  google.protobuf.Struct context = 3;
}

message GetCurrentSessionRequest {
  string id = 2;
}

message GetCurrentSessionResponse {
  optional google.protobuf.Timestamp session_expiry = 1;
  google.protobuf.Timestamp access_token_expiry = 2;
  optional string organization_id = 3;
  string subject = 4;
  optional string email = 5;
}

message ResourceMetadata {
  enum ResourceType {
    organization = 0;
    connection = 1;
    auth_request = 2;
  }
  ResourceType type = 1;
  repeated string identifiers = 2;
}

message ScalekitResourceRequest {
  repeated ResourceMetadata resources = 1;
}

message ScalekitResourceResponse {
  map<string, google.protobuf.Struct> resources = 1;
}
